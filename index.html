<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Geomap</title>
  <!-- Leaflet CSS and JavaScript -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Leaflet.heat plugin -->
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    /* Set height of body and document to 100% */
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial;
    }

    /* Style tab links */
    .tablink {
      background-color: #333;
      color: white;
      float: left;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      font-size: 17px;
      width: calc(100%/3);
    }

    .tablink:hover {
      background-color: #777;
    }

    /* Style the tab content */
    .tabcontent {
      color: white;
      display: none;
      padding: 100px 20px;
      min-height: 100vh; /* Ensure tab content takes full viewport height */
      box-sizing: border-box;
    }

    #Home {background-color: red;}
    #About {background-color: green;}
    #Contact {
      background-color: blue;
      padding: 100px 40px; /* Increased padding for better card containment */
    }

    #title {
      display: flex;
      justify-content: center;
      height: 50px;
      margin: 10px;
    }

    #map-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    #map, #nyc-map, #nys-map {
      height: 500px;
      width: 100%;
    }

    #nyc-map {
      position: relative;
    }

    #nys-map {
      position: relative;
      display: none;
    }

    #toggleButton {
      position: absolute;
      top: 268px;
      right: 30px;
      background-color: rgba(255, 255, 255, 0.7);
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
    }

    #toggleButton:hover {
      color: #DDD;
      background-color: #555;
    }

    #input-form {
      position: absolute;
      top: 5px;
      right: 5px;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
    }

    .input-label {
      display: inline-block;
      margin-bottom: 25px;
      margin-right: 10px;
      font-weight: bold;
    }

    .input-field#city {
      width: 100px;
      margin-bottom: 10px;
    }

    .input-field#state {
      width: 50px;
      margin-bottom: 10px;
    }

    .input-field#comment {
      width: 100%;
      height: 60px;
      margin-bottom: 10px;
    }

    .marker-tooltip {
      background-color: rgba(255, 255, 255, 0.8);
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      width: 200px;
      color: black;
    }

    .category {
      margin-bottom: 5px;
    }

    .star-rating {
      color: gold;
    }

    .star-rating .fa-star-o {
      color: #ccc;
    }

    #add-marker-btn,
    #add-destination-btn {
      background-color: #DDD;
      color: #000;
      padding: 5px;
      border: 1px solid #DDD;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }

    #add-marker-btn:hover,
    #add-destination-btn:hover {
      background-color: #555;
      color: #DDD;
      border: 1px solid #DDD;
    }

    #reset-button {
      background-color: #000;
      color: #DDD;
      padding: 5px;
      border: 0px solid #DDD;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }

    #reset-button:hover {
      background-color: #DDD;
      color: #555;
      border: 5px solid #DDD;
    }

    #distance-info {
      position: absolute;
      bottom: 10px;
      left: 30px;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      color: black;
    }

    /* About Tab Specific Styles */
    .accordion {
      background-color: #eee;
      color: #444;
      cursor: pointer;
      padding: 18px;
      width: 100%;
      border: none;
      text-align: left;
      outline: none;
      font-size: 15px;
      transition: 0.4s;
    }

    .active, .accordion:hover {
      background-color: #ccc;
    }

    .accordion:after {
      content: '\002B';
      color: #777;
      font-weight: bold;
      float: right;
      margin-left: 5px;
    }

    .active:after {
      content: "\2212";
    }

    .panel {
      padding: 0 18px;
      background-color: darkgrey;
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.2s ease-out;
    }

    .tag-cloud {
      display: inline-block;
      color: white;
      padding: 8px 20px;
      font-family: Arial;
      border-radius: 25px;
      background-color: #2196F3;
      margin-top: 8px;
    }

    table {
      width: 100%;
      border: 1px solid #ddd;
    }

    td {
      padding: 16px;
    }

    td > table {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 100%;
    }

    tr:nth-child(even) {
      background-color: #eee;
    }

    .row {
      margin-left: -5px;
      margin-right: -5px;
    }

    .column {
      float: left;
      width: 50%;
      padding: 5px;
    }

    .row::after {
      content: "";
      clear: both;
      display: table;
    }

    .table-container {
      overflow-x: auto;
    }

    .responsive-table {
      width: 100%;
      table-layout: auto;
    }

    th, td {
      text-align: left;
      padding: 16px;
    }

    tr:nth-child(even) {
      background-color: #f2f2f2;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    .fa-check {
      color: darkgreen;
    }

    .fa-remove {
      color: red;
    }
  </style>
</head>
<body>
  <h1 id="title">Geomap</h1>
  <button class="tablink" onclick="openPage('Home', this, 'red')" id="defaultOpen">Home</button>
  <button class="tablink" onclick="openPage('About', this, 'green')">About</button>
  <button class="tablink" onclick="openPage('Contact', this, 'blue')">Contact</button>

  <!-- Home Tab -->
  <div id="Home" class="tabcontent">
    <h3>Home</h3>
    <p>Home is where the heart is..</p>
    <div id="map-container">
      <div id="map">
        <div id="input-form">
          <div style="margin-right: 10px;">
            <label class="input-label" for="city" style="color: #444">City:</label>
            <select class="input-field" id="city" onchange="updateState()" placeholder="Enter city">
              <option value="New York">New York</option>
              <option value="Los Angeles">Los Angeles</option>
              <option value="Chicago">Chicago</option>
              <option value="Houston">Houston</option>
              <option value="Phoenix">Phoenix</option>
            </select>
          </div>
          <div>
            <label class="input-label" for="state" style="color: #444">State:</label>
            <select class="input-field" id="state" onchange="updateCity()" placeholder="Enter state">
              <option value="NY">NY</option>
              <option value="CA">CA</option>
              <option value="IL">IL</option>
              <option value="TX">TX</option>
              <option value="AZ">AZ</option>
            </select>
          </div>
          <button id="add-marker-btn" onclick="addCustomMarker()">+Marker</button>
          <button id="add-destination-btn" onclick="addCustomDestination()">+Destination</button>
          <button id="reset-button" class="reset-map-icon" title="Reset Zoom">Reset</button>
        </div>
      </div>
      <button id="toggleButton">Toggle Maps</button>
      <div id="nys-map"></div>
      <div id="nyc-map"></div>
      <div id="distance-info"></div>
    </div>
  </div>

  <!-- About Tab -->
  <div id="About" class="tabcontent">
    <h3>About</h3>
    <p>Who we are and what we do.</p>
    <button class="accordion">Immortal Empire</button>
    <div class="panel">
      <h1>Primary School</h1>
      <p>Marvelous</p>
      <span class="tag-cloud">Go 5d</span>
      <span class="tag-cloud">Billiards 5th</span>
      <span class="tag-cloud">Piano Level 2</span>
      <span class="tag-cloud">English Club President</span>
      <span class="tag-cloud">Pass of English Level Test</span>
    </div>

    <button class="accordion">Sleeping Empire</button>
    <div class="panel">
      <h1>Middle School</h1>
      <p>Falling</p>
      <span class="tag-cloud">Go 6th</span>
      <span class="tag-cloud">Morning Exercise 1st</span>
      <span class="tag-cloud">Lu Xun Literature Prize 3rd</span>
    </div>

    <button class="accordion">Harmony Empire</button>
    <div class="panel">
      <h1>High School</h1>
      <p>Spiritual</p>
      <span class="tag-cloud">Table Tennis Club President</span>
      <span class="tag-cloud">History Geography Politics 3 Straight As</span>
    </div>

    <button class="accordion">Rejuvenation Empire</button>
    <div class="panel">
      <h1>Undergrad and Grad</h1>
      <p>Reviving</p>
      <span class="tag-cloud">Go 2nd</span>
      <span class="tag-cloud">Go Club President</span>
      <span class="tag-cloud">ELSO Club Vice President</span>
      <span class="tag-cloud">Dean's List</span>
      <span class="tag-cloud">International Student Ambassador</span>
    </div>

    <script>
      var acc = document.getElementsByClassName("accordion");
      for (var i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
          } else {
            panel.style.maxHeight = panel.scrollHeight + "px";
          }
        });
      }
    </script>

    <br><hr><br>

    <details>
      <summary>Nested Table</summary>
      <h2>Nested Table</h2>
      <p>An example of how to create a table inside a table:</p>
      <table>
        <td>Vegetable</td>
        <td>
          <table>
            <tr><td>Seasoning 1</td><td>Seasoning 2</td></tr>
            <tr><td style="color: black;">Soy Sauce</td><td style="color: black;">Prickly Ash Oil</td></tr>
          </table>
          <br>
          <table>
            <tr><td>Condiment 1</td><td>Condiment 2</td><td>Condiment 3</td></tr>
            <tr><td style="color: black;">Garlic</td><td style="color: black;">Cilantro</td><td style="color: black;">leek</td></tr>
          </table>
        </td>
      </table>
      <table>
        <td>Meat</td>
        <td>
          <table>
            <tr><td>Seasoning 1</td><td>Seasoning 2</td><td>Seasoning 3</td></tr>
            <tr><td style="color: black;">Soy Sauce</td><td style="color: black;">Oyster Oil</td><td style="color: black;">Sesame Oil</td></tr>
          </table>
          <br>
          <table>
            <tr><td>Condiment 1</td></tr>
            <tr><td style="color: black;">Onion</td></tr>
          </table>
        </td>
      </table>
    </details>

    <br><hr><br>

    <details>
      <summary>Tables Side by Side</summary>
      <h2>Tables Side by Side</h2>
      <p>How to create side-by-side tables with CSS:</p>
      <div class="row">
        <div class="column">
          <div class="table-container">
            <tr>East</tr>
            <table class="responsive-table">
              <tr><th>Cost</th><th>Feeling</th><th>Quality</th><th>Noise</th><th>View</th><th>Exercising</th><th>Privacy</th></tr>
              <tr>
                <td style="color: red;">3/5</td>
                <td style="color: red;">3/5</td>
                <td style="color: red;">3/5</td>
                <td style="color: red;">3/5</td>
                <td style="color: orange;">4/5</td>
                <td style="color: green;">5/5</td>
                <td style="color: green;">5/5</td>
              </tr>
            </table>
          </div>
        </div>
        <div class="column">
          <div class="table-container">
            <tr>West</tr>
            <table class="responsive-table">
              <tr><th>Cost</th><th>Feeling</th><th>Quality</th><th>Noise</th><th>View</th><th>Exercising</th><th>Privacy</th></tr>
              <tr>
                <td style="color: orange;">4/5</td>
                <td style="color: orange;">4/5</td>
                <td style="color: orange;">4/5</td>
                <td style="color: orange;">4/5</td>
                <td style="color: red;">3/5</td>
                <td style="color: red;">3/5</td>
                <td style="color: green;">5/5</td>
              </tr>
            </table>
          </div>
        </div>
      </div>
    </details>

    <br><hr><br>

    <details>
      <summary>Comparison Table</summary>
      <h2>Comparison Table</h2>
      <p>How to create side-by-side tables with CSS:</p>
      <table>
        <tr><th style="width:50%">Features</th><th>East</th><th>West</th></tr>
        <tr>
          <td class="sample-text" style="color: black;">Aviation</td>
          <td><i class="fa fa-check"></i></td>
          <td><i class="fa fa-remove"></i></td>
        </tr>
        <tr>
          <td class="sample-text" style="color: white;">Railway</td>
          <td><i class="fa fa-check" style="color: darkgreen;"></i></td>
          <td><i class="fa fa-remove"></i></td>
        </tr>
        <tr>
          <td class="sample-text" style="color: black;">Bus</td>
          <td><i class="fa fa-check"></i></td>
          <td><i class="fa fa-check"></i></td>
        </tr>
        <tr>
          <td class="sample-text" style="color: white;">Car</td>
          <td><i class="fa fa-remove"></i></td>
          <td><i class="fa fa-check" style="color: darkgreen;"></i></td>
        </tr>
      </table>
    </details>
  </div>

  <!-- Contact Tab -->
  <div id="Contact" class="tabcontent">
    <h3>Contact</h3>
    <p>Get in touch, or swing by for a cup of coffee.</p>

    <!-- Social Media Icon Bar -->
    <div class="icon-bar">
      <a href="#" class="facebook"><i class="fa fa-facebook"></i></a>
      <a href="https://twitter.com/MORPC/status/1755293007157330063" class="twitter"><i class="fa fa-twitter"></i></a>
      <a href="#" class="google"><i class="fa fa-google"></i></a>
      <a href="#" class="linkedin"><i class="fa fa-linkedin"></i></a>
      <a href="#" class="youtube"><i class="fa fa-youtube"></i></a>
    </div>

    <!-- Flip Card Container -->
    <div class="flip-card-container">
      <!-- Flip Cards Data -->
      <script>
        const contactCities = [
          { name: 'Stony Brook', state: 'NY', data: [100, 100, 90, 90] },
          { name: 'Ithaca', state: 'NY', data: [80, 80, 90, 50] },
          { name: 'Washington DC', state: 'DC', data: [60, 70, 80, 100] },
          { name: 'Columbus', state: 'OH', data: [70, 70, 70, 50] }
        ];
      </script>

      <!-- Flip Card Template -->
      <script type="text/template" id="flip-card-template">
        <div class="flip-card">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <img src="https://cdn-icons-png.flaticon.com/128/3916/3916882.png" alt="Avatar" style="width:100%;height:300px;object-fit:cover;">
            </div>
            <div class="flip-card-back">
              <h1>{{name}}</h1>
              <p>{{state}}</p>
              <div class="radar-container">
                <canvas id="radarChart{{index}}" class="radarchart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </script>
    </div>

    <!-- Contact Tab Specific Styles -->
    <style>
      .icon-bar {
        position: fixed;
        top: 435px;
        transform: translateY(-50%);
      }
      .icon-bar a {
        display: block;
        text-align: center;
        padding: 16px;
        transition: all 0.3s ease;
        color: white;
        font-size: 20px;
      }
      .icon-bar a:hover { background-color: #000; }
      .facebook { background: #3B5998; }
      .twitter { background: #55ACEE; }
      .google { background: #dd4b39; }
      .linkedin { background: #007bb5; }
      .youtube { background: #bb0000; }

      .flip-card-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 450px));
        gap: 40px; /* Increased gap for more space between cards */
        justify-content: center;
        max-width: 980px; /* Adjusted for 2 × 450px + 40px gap */
        margin: 0 auto; /* Center the container */
        padding: 20px; /* Added padding to ensure spacing around cards */
      }
      .flip-card {
        background-color: transparent;
        width: 450px; /* Fixed width */
        height: 600px; /* Fixed height */
        perspective: 1000px;
        margin: 0; /* Ensure no margins cause overlap */
      }
      .flip-card-inner {
        position: relative;
        width: 100%;
        height: 100%;
        text-align: center;
        transition: transform 0.6s;
        transform-style: preserve-3d;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      .flip-card:hover .flip-card-inner {
        transform: rotateY(180deg);
      }
      .flip-card-front, .flip-card-back {
        position: absolute;
        width: 100%;
        height: 100%;
        backface-visibility: hidden;
        overflow: hidden; /* Prevent content overflow */
      }
      .flip-card-front {
        background-color: #bbb;
        color: black;
      }
      .flip-card-back {
        background-color: #2980b9;
        color: white;
        transform: rotateY(180deg);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
      }
      .radar-container {
        width: 100%;
        max-width: 350px; /* Fits within card */
        height: 350px;
        margin-top: 20px;
      }
      .radarchart {
        width: 100% !important;
        height: 100% !important;
      }
    </style>

    <!-- Chart.js and Radar Chart Initialization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <script>
      // Radar chart configuration
      const radarChartOptions = {
        maintainAspectRatio: false,
        scales: {
          r: {
            min: 0,
            max: 100,
            ticks: { beginAtZero: true, stepSize: 20 }
          }
        },
        plugins: {
          legend: { position: 'top' }
        }
      };

      const radarChartTemplate = {
        labels: ['Safety', 'Health', 'Environment', 'Transportation'],
        datasets: [
          {
            label: 'City',
            data: [],
            fill: true,
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            borderColor: 'rgb(255, 99, 132)',
            pointBackgroundColor: 'rgb(255, 99, 132)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(255, 99, 132)'
          },
          {
            label: 'Nation',
            data: [50, 50, 50, 50],
            fill: true,
            backgroundColor: 'rgba(54, 162, 235, 0.5)',
            borderColor: 'rgb(54, 162, 235)',
            pointBackgroundColor: 'rgb(54, 162, 235)',
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: 'rgb(54, 162, 235)'
          }
        ]
      };

      // Dynamically generate flip cards and radar charts
      document.addEventListener('DOMContentLoaded', () => {
        const container = document.querySelector('.flip-card-container');
        const template = document.getElementById('flip-card-template').innerHTML;

        contactCities.forEach((city, index) => {
          let html = template.replace('{{name}}', city.name)
                            .replace('{{state}}', city.state)
                            .replace('{{index}}', index);
          container.insertAdjacentHTML('beforeend', html);

          const chartData = JSON.parse(JSON.stringify(radarChartTemplate));
          chartData.datasets[0].label = city.name;
          chartData.datasets[0].data = city.data;

          const canvas = document.getElementById(`radarChart${index}`);
          canvas.width = 350;
          canvas.height = 350;

          new Chart(canvas, {
            type: 'radar',
            data: chartData,
            options: radarChartOptions
          });
        });
      });
    </script>
  </div>

  <!-- JavaScript for Map and Tab Functionality -->
  <script>
    // Function to initialize Leaflet maps
    function initMaps() {
      var maps = document.querySelectorAll('.tabcontent .map');
      maps.forEach(function(map) {
        var leafletMap = L.map(map).setView([51.505, -0.09], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(leafletMap);
      });
    }

    // Function to open a tab
    function openPage(pageName, elmnt, color) {
      var tabcontent = document.getElementsByClassName("tabcontent");
      for (var i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      var tablinks = document.getElementsByClassName("tablink");
      for (var i = 0; i < tablinks.length; i++) {
        tablinks[i].style.backgroundColor = "";
      }
      document.getElementById(pageName).style.display = "block";
      elmnt.style.backgroundColor = color;
      initMaps();
    }

    // Open default tab
    document.getElementById("defaultOpen").click();

    // Prevent accidental input addition
    document.getElementById('input-form').addEventListener('click', function(event) {
      event.stopPropagation();
    });

    var map = L.map('map').setView([40.0, -98.0], 4);
    var currentPopup = null;
    var targetPoint = null;
    var markers = [];
    var destinationMarkers = [];
    var distanceInfo = document.getElementById('distance-info');
    var PurpleLines = L.layerGroup().addTo(map);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    var heatLayer = L.heatLayer([], {
      radius: 20,
      gradient: { 0.4: 'blue', 0.65: 'silver', 1: 'red' }
    }).addTo(map);

    var stateAbbreviations = {
      "Alabama": "AL", "Alaska": "AK", "Arizona": "AZ", "Arkansas": "AR", "California": "CA",
      "Colorado": "CO", "Connecticut": "CT", "Delaware": "DE", "Florida": "FL", "Georgia": "GA",
      "Hawaii": "HI", "Idaho": "ID", "Illinois": "IL", "Indiana": "IN", "Iowa": "IA",
      "Kansas": "KS", "Kentucky": "KY", "Louisiana": "LA", "Maine": "ME", "Maryland": "MD",
      "Massachusetts": "MA", "Michigan": "MI", "Minnesota": "MN", "Mississippi": "MS", "Missouri": "MO",
      "Montana": "MT", "Nebraska": "NE", "Nevada": "NV", "New Hampshire": "NH", "New Jersey": "NJ",
      "New Mexico": "NM", "New York": "NY", "North Carolina": "NC", "North Dakota": "ND", "Ohio": "OH",
      "Oklahoma": "OK", "Oregon": "OR", "Pennsylvania": "PA", "Rhode Island": "RI", "South Carolina": "SC",
      "South Dakota": "SD", "Tennessee": "TN", "Texas": "TX", "Utah": "UT", "Vermont": "VT",
      "Virginia": "VA", "Washington": "WA", "West Virginia": "WV", "Wisconsin": "WI", "Wyoming": "WY"
    };

    function updateState() {
      var city = document.getElementById('city').value;
      var stateField = document.getElementById('state');
      switch (city) {
        case 'New York': stateField.value = 'NY'; break;
        case 'Los Angeles': stateField.value = 'CA'; break;
        case 'Chicago': stateField.value = 'IL'; break;
        case 'Houston': stateField.value = 'TX'; break;
        case 'Phoenix': stateField.value = 'AZ'; break;
        default: stateField.value = ''; break;
      }
    }

    function updateCity() {
      var cityField = document.getElementById('city');
      var state = document.getElementById('state').value;
      switch (state) {
        case 'NY': cityField.value = 'New York'; break;
        case 'CA': cityField.value = 'Los Angeles'; break;
        case 'IL': cityField.value = 'Chicago'; break;
        case 'TX': cityField.value = 'Houston'; break;
        case 'AZ': cityField.value = 'Phoenix'; break;
        default: cityField.value = ''; break;
      }
    }

    map.on('click', function(e) {
      addMarker(e.latlng);
      updateHeatmap();
      updateDistanceInfo();
    });

    function addMarker(latlng) {
      var marker = L.marker(latlng, { draggable: true }).addTo(map);
      markers.push(marker);
      marker.on('dragend', function() {
        updateHeatmap();
        updateDistanceInfo();
      });
      marker.on('click', function() {
        showGeospatialInfo(marker);
      });
    }

    function showGeospatialInfo(marker) {
      var latlng = marker.getLatLng();
      var nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`;
      fetch(nominatimUrl)
        .then(response => response.json())
        .then(data => {
          var city = data.address.city || data.address.village || data.address.town || data.address.hamlet;
          var state = data.address.state || data.address.state_district || data.address.region;
          var stateAbbreviation = stateAbbreviations[state] || state;
          var popupContent = `
            <div>
              <h3>${city}, ${stateAbbreviation}</h3>
              <hr>
              <p1>Longitude: ${latlng.lng.toFixed(5)}</p1><br>
              <p2>Latitude: ${latlng.lat.toFixed(5)}</p2><br><br>
              <label class="input-label" for="comment">Comment:</label>
              <textarea class="input-field" id="comment" placeholder="Add a comment"></textarea>
              <button onclick="setComment(${markers.indexOf(marker)})">Add Comment</button><br>
              <button onclick="deleteMarker(${markers.indexOf(marker)})">Delete</button>
            </div>
          `;
          if (currentPopup) map.closePopup(currentPopup);
          currentPopup = L.popup().setLatLng(latlng).setContent(popupContent).openOn(map);
        })
        .catch(error => console.error('Error fetching location information:', error));
    }

    function showGeospatialInform(destinationMarker) {
      var latlng = destinationMarker.getLatLng();
      var nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`;
      fetch(nominatimUrl)
        .then(response => response.json())
        .then(data => {
          var city = data.address.city || data.address.village || data.address.town || data.address.hamlet;
          var state = data.address.state || data.address.state_district || data.address.region;
          var stateAbbreviation = stateAbbreviations[state] || state;
          var popupContent = `
            <div>
              <h3>${city}, ${stateAbbreviation}</h3>
              <hr>
              <p1>Longitude: ${latlng.lng.toFixed(5)}</p1><br>
              <p2>Latitude: ${latlng.lat.toFixed(5)}</p2><br><br>
              <label class="input-label" for="comment">Comment:</label>
              <textarea class="input-field" id="comment" placeholder="Add a comment"></textarea>
              <button onclick="setComment(${destinationMarkers.indexOf(destinationMarker)})">Add Comment</button><br>
              <button onclick="deleteDestinationMarker(${destinationMarkers.indexOf(destinationMarker)})">Delete</button>
            </div>
          `;
          if (currentPopup) map.closePopup(currentPopup);
          currentPopup = L.popup().setLatLng(latlng).setContent(popupContent).openOn(map);
        })
        .catch(error => console.error('Error fetching location information:', error));
    }

    function setComment(index) {
      var marker = markers[index];
      var comment = document.getElementById('comment').value;
      var popupContent = marker.getPopup().getContent();
      popupContent = popupContent.replace(/<label class="input-label" for="comment">Comment:<\/label>\s*<textarea class="input-field" id="comment" placeholder="Add a comment">[^<]*<\/textarea>/, `<label class="input-label" for="comment">Comment:</label><textarea class="input-field" id="comment" readonly>${comment}</textarea>`);
      marker.getPopup().setContent(popupContent);
      map.closePopup(currentPopup);
    }

    function deleteMarker(index) {
      var marker = markers[index];
      if (currentPopup) map.closePopup(currentPopup);
      map.removeLayer(marker);
      markers.splice(index, 1);
      updateHeatmap();
      updateDistanceInfo();
    }

    function updateHeatmap() {
      var latLngPoints = markers.map(function(marker) {
        return marker.getLatLng();
      });
      var heatLatLngs = latLngPoints.map(function(latlng) {
        return [latlng.lat, latlng.lng];
      });
      heatLayer.setLatLngs(heatLatLngs);
      PurpleLines.clearLayers();
      for (var i = 0; i < markers.length; i++) {
        for (var j = i + 1; j < markers.length; j++) {
          var marker1 = markers[i].getLatLng();
          var marker2 = markers[j].getLatLng();
          var distance = marker1.distanceTo(marker2) * 0.000621371;
          if (distance <= 1) {
            var line = L.polyline([marker1, marker2], { color: 'purple' });
            PurpleLines.addLayer(line);
          }
        }
      }
    }

    function addCustomMarker() {
      var city = document.getElementById('city').value;
      var state = document.getElementById('state').value;
      if (city && state) {
        var nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${city},${state}`;
        fetch(nominatimUrl)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              var latlng = L.latLng(data[0].lat, data[0].lon);
              addMarker(latlng);
            } else {
              console.error('Location not found');
            }
          })
          .catch(error => console.error('Error fetching location information:', error));
      } else {
        console.error('City and state are required');
      }
    }

    function addCustomDestination() {
      var city = document.getElementById('city').value;
      var state = document.getElementById('state').value;
      if (city && state) {
        var nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${city},${state}`;
        fetch(nominatimUrl)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              var latlng = L.latLng(data[0].lat, data[0].lon);
              addDestinationMarker(latlng);
            } else {
              console.error('Destination location not found');
            }
          })
          .catch(error => console.error('Error fetching destination information:', error));
      } else {
        console.error('Destination city and state are required');
      }
    }

    function addDestinationMarker(latlng) {
      var destinationMarker = L.marker(latlng, { icon: createDestinationIcon(), draggable: true }).addTo(map);
      destinationMarkers.push(destinationMarker);
      destinationMarker.on('dragend', function() {
        updateHeatmap();
        updateDistanceInfo();
      });
      destinationMarker.on('click', function() {
        showGeospatialInform(destinationMarker);
      });
    }

    function createDestinationIcon() {
      return L.divIcon({
        className: 'destination-marker',
        iconSize: [12, 12],
        iconAnchor: [6, 6],
        html: '<div style="background-color: red; border-radius: 50%; width: 12px; height: 12px;"></div>',
      });
    }

    function deleteDestinationMarker(index) {
      var destinationMarker = destinationMarkers[index];
      if (currentPopup) map.closePopup(currentPopup);
      map.removeLayer(destinationMarker);
      destinationMarkers.splice(index, 1);
      updateHeatmap();
      updateDistanceInfo();
    }

    function updateDistanceInfo() {
      if (destinationMarkers.length > 0) {
        var distances = destinationMarkers.map(function(destinationMarker) {
          var destinationLatLng = destinationMarker.getLatLng();
          var totalDistance = markers.reduce(function(sum, marker) {
            var blueMarker = marker.getLatLng();
            var distance = blueMarker.distanceTo(destinationLatLng);
            return sum + distance;
          }, 0);
          var totalDistanceMiles = totalDistance * 0.000621371;
          return totalDistanceMiles.toFixed(2) + ' miles';
        });
        distanceInfo.innerHTML = '<strong>Sum of Total Distances to Markers:</strong> ' + distances.join(', ');
      } else {
        distanceInfo.innerHTML = '<strong>No destination markers added.</strong>';
      }
    }

    // Initialize New York State map
    var nysMap = L.map('nys-map').setView([40.0, -98.0], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(nysMap);

    // Define city data with ratings
    var cities = [
      { name: 'Cortland', location: [42.6012, -76.1805], ratings: { Safety: 5, Health: 4, Environment: 4, Transportation: 2 }, iconUrl: 'cortland-icon.png' },
      { name: 'Rochester', location: [43.1566, -77.6088], ratings: { Safety: 3, Health: 3, Environment: 3, Transportation: 4 }, iconUrl: 'rochester-icon.png' },
      { name: 'Pittsburgh', location: [40.4406, -79.9959], ratings: { Safety: 3, Health: 3, Environment: 4, Transportation: 4 }, iconUrl: 'pittsburgh-icon.png' },
      { name: 'Albany', location: [42.6526, -73.7562], ratings: { Safety: 3, Health: 5, Environment: 3, Transportation: 3 }, iconUrl: 'albany-icon.png' },
      { name: 'Indianapolis', location: [39.7691, -86.1580], ratings: { Safety: 3, Health: 3, Environment: 4, Transportation: 4 }, iconUrl: 'indianapolis-icon.png' },
      { name: 'Chicago', location: [41.8781, -87.6298], ratings: { Safety: 4, Health: 4, Environment: 5, Transportation: 5 }, iconUrl: 'chicago-icon.png' },
      { name: 'Denver', location: [39.7392, -104.9903], ratings: { Safety: 5, Health: 4, Environment: 5, Transportation: 5 }, iconUrl: 'raleigh-icon.png' },
    ];

    var markers = [];
    var hoveredMarker = null;

    nysMap.on('click', function(e) {
      markers = markers.filter(function(marker) {
        if (hoveredMarker && marker == hoveredMarker) {
          marker.remove();
          return false;
        }
        return true;
      });
      var maxDistance = 100000;
      cities.forEach(function(city) {
        var cityLocation = L.latLng(city.location[0], city.location[1]);
        var clickedLocation = L.latLng(e.latlng.lat, e.latlng.lng);
        var distance = cityLocation.distanceTo(clickedLocation);
        if (distance <= maxDistance) {
          var categoriesHTML = '';
          Object.keys(city.ratings).forEach(function(category) {
            var starsHTML = '';
            for (var i = 0; i < city.ratings[category]; i++) {
              starsHTML += '<i class="fa fa-star star-rating"></i>';
            }
            for (var j = city.ratings[category]; j < 5; j++) {
              starsHTML += '<i class="fa fa-star-o star-rating"></i>';
            }
            categoriesHTML += '<div class="category"><span class="category-label">' + category + ': </span>' + starsHTML + '</div>';
          });
          var popupContent = '<b>' + city.name + '</b><br>' + categoriesHTML + '<br>';
          var icon = L.divIcon({
            className: 'custom-icon',
            html: '<div class="marker-tooltip">' + popupContent + '</div>',
            iconSize: [30, 42],
            iconAnchor: [15, 42],
            popupAnchor: [0, -42],
          });
          var marker = L.marker(city.location, { icon: icon }).addTo(nysMap);
          marker.on('mouseover', function() { hoveredMarker = marker; });
          marker.on('mouseout', function() { hoveredMarker = null; });
          markers.push(marker);
        }
      });
    });

    // Initialize New York City map
    var nycMap = L.map('nyc-map').setView([40.0, -98.0], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(nycMap);

    // City markers for nycMap
    var cityMarkers = [
      { coords: [42.3601, -71.0589], name: 'Boston', desc: 'England Capital of the United States' },
      { coords: [41.8240, -71.4128], name: 'Providence', desc: 'Manor Capital of the United States' },
      { coords: [42.6526, -73.7562], name: 'Albany', desc: 'Empire Capital of the United States' },
      { coords: [43.0481, -76.1474], name: 'Syracuse', desc: 'Snow Capital of the United States' },
      { coords: [43.1566, -77.6088], name: 'Rochester', desc: 'Light Capital of the United States' },
      { coords: [43.0962, -79.0377], name: 'Niagara Falls', desc: 'Hydroelectric Capital of the United States' },
      { coords: [40.7128, -74.0060], name: 'New York City', desc: 'Skyline Capital of the United States' },
      { coords: [39.9526, -75.1652], name: 'Philadelphia', desc: 'Revolution Capital of the United States' },
      { coords: [40.4406, -79.9959], name: 'Pittsburgh', desc: 'Steel Capital of the United States' },
      { coords: [41.4993, -81.6944], name: 'Cleveland', desc: 'Superman Capital of the United States' },
      { coords: [42.3297, -83.0425], name: 'Detroit', desc: 'Engine Capital of the United States' },
      { coords: [39.7589, -84.1916], name: 'Dayton', desc: 'Air Capital of the United States' },
      { coords: [39.9612, -82.9988], name: 'Columbus', desc: 'Veterans Capital of the United States' },
      { coords: [39.1031, -84.5120], name: 'Cincinnati', desc: 'Fancy Capital of the United States' },
      { coords: [39.7684, -86.1581], name: 'Indianapolis', desc: 'Interstate Capital of the United States' },
      { coords: [41.8781, -87.6298], name: 'Chicago', desc: 'Planning Capital of the United States' },
      { coords: [39.2904, -76.6122], name: 'Baltimore', desc: 'Harbor Capital of the United States' },
      { coords: [38.9072, -77.0369], name: 'Washington DC', desc: 'Embassy Capital of the United States' },
      { coords: [37.5407, -77.4360], name: 'Richmond', desc: 'Slave Capital of the United States' },
      { coords: [38.3498, -81.6326], name: 'Charleston', desc: 'Shanshui Capital of the United States' },
      { coords: [35.7796, -78.6382], name: 'Raleigh', desc: 'Life Capital of the United States' },
      { coords: [35.7915, -78.7811], name: 'Cary', desc: 'Community Capital of the United States' },
      { coords: [35.9557, -80.0053], name: 'High Point', desc: 'Drawer Capital of the United States' },
      { coords: [35.2271, -80.8431], name: 'Charlotte', desc: 'Charming Capital of the United States' },
      { coords: [32.7833, -79.9320], name: 'Charleston', desc: 'Colorful Capital of the United States' },
      { coords: [32.0809, -81.0912], name: 'Savannah', desc: 'Fountain Capital of the United States' },
      { coords: [33.7488, -84.3877], name: 'Atlanta', desc: 'Southern Capital of the United States' },
      { coords: [36.1627, -86.7816], name: 'Nashville', desc: 'Music Capital of the United States' },
      { coords: [28.5384, -81.3789], name: 'Orlando', desc: 'Fun Capital of the United States' },
      { coords: [26.1224, -80.1373], name: 'Fort Lauderdale', desc: 'Waterway Capital of the United States' },
      { coords: [25.7617, -80.1918], name: 'Miami', desc: 'Beach Capital of the United States' },
      { coords: [44.9778, -93.2650], name: 'Minneapolis', desc: 'Skyway Capital of the United States' },
      { coords: [44.0805, -103.2310], name: 'Rapid City', desc: 'President Capital of the United States' },
      { coords: [41.2565, -95.9345], name: 'Omaha', desc: 'Westward Capital of the United States' },
      { coords: [39.0997, -94.5786], name: 'Kansas City', desc: 'Confluence Capital of the United States' },
      { coords: [38.6274, -90.1982], name: 'St. Louis', desc: 'Arch Capital of the United States' },
      { coords: [35.4689, -97.5195], name: 'Oklahoma City', desc: 'Tribe Capital of the United States' },
      { coords: [32.7555, -97.3308], name: 'Fort Worth', desc: 'Cowboy Capital of the United States' },
      { coords: [29.9509, -90.0758], name: 'New Orleans', desc: 'Swamp Capital of the United States' },
      { coords: [40.0150, -105.2705], name: 'Boulder', desc: 'Geoscience Capital of the United States' },
      { coords: [39.7555, -105.2211], name: 'Golden', desc: 'Mines Capital of the United States' },
      { coords: [39.7392, -104.9903], name: 'Denver', desc: 'Golden Capital of the United States' },
      { coords: [38.8339, -104.8214], name: 'Colorado Springs', desc: 'Force Capital of the United States' },
      { coords: [36.1716, -115.1391], name: 'Las Vegas', desc: 'World Capital of the United States' },
      { coords: [40.7606, -111.8881], name: 'Salt Lake City', desc: 'Family Capital of the United States' },
      { coords: [33.4482, -112.0777], name: 'Phoenix', desc: 'Sun Capital of the United States' },
      { coords: [47.6061, -122.3328], name: 'Seattle', desc: 'Space Capital of the United States' },
      { coords: [45.5152, -122.6784], name: 'Portland', desc: 'Green Capital of the United States' },
      { coords: [37.7749, -122.4194], name: 'San Francisco', desc: 'Slope Capital of the United States' },
      { coords: [34.0549, -118.2426], name: 'Los Angeles', desc: 'Movie Capital of the United States' },
      { coords: [32.7157, -117.1611], name: 'San Diego', desc: 'Navy Capital of the United States' }
    ];

    cityMarkers.forEach(function(city) {
      var marker = L.marker(city.coords).addTo(nycMap).bindPopup(`<b>${city.name}</b><br>${city.desc}`);
      marker.on('mouseover', function() { this.openPopup(); });
      marker.on('mouseout', function() { if (!marker.clicked) this.closePopup(); });
      marker.on('click', function() {
        marker.clicked = !marker.clicked;
        if (marker.clicked) this.openPopup();
        else this.closePopup();
      });
    });

    // Toggle map visibility
    document.getElementById('toggleButton').addEventListener('click', function() {
      var nycMapDiv = document.getElementById('nyc-map');
      var nysMapDiv = document.getElementById('nys-map');
      if (nycMapDiv.style.display === 'none') {
        nycMapDiv.style.display = 'block';
        nysMapDiv.style.display = 'none';
        nycMap.invalidateSize();
      } else {
        nycMapDiv.style.display = 'none';
        nysMapDiv.style.display = 'block';
        nysMap.invalidateSize();
      }
    });

    // Reset zoom function
    function resetZoom() {
      map.setView([40.0, -98.0], 4);
      nycMap.setView([40.0, -98.0], 4);
      nysMap.setView([40.0, -98.0], 4);
    }

    document.getElementById('reset-button').addEventListener('click', resetZoom);
  </script>
</body>
</html>